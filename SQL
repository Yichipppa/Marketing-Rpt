with 
New_tb as (
select  
  case
    when hs_language ilike '%English%' or hs_language='en-US' 
    then 'English' 
     else 'Non-Engish' 
  end as language,
  Demo_booked_status_Sales_Ops, --TBD
  case 
     when Inquiry_Path_Classification = 'Camp Member - Demo HandRaiser'  
        and  all_Demo_status <> 'Demo Requested from Product'  then 'Non-product Demo Requests' 
     else null 
  end as demo_requested_nonProd,
 case 
    when Inquiry_Path_Classification = 'Camp Member - Demo HandRaiser' 
    and  all_Demo_status= 'Demo Requested from Product' then 'In-product Demo Requests'
    else null 
 end as demo_request_Prod,
case 
   when Inquiry_Path_Classification = 'Camp Member - Demo HandRaiser'  
   and  all_Demo_status <> 'Demo Requested from Product'  then 'Non-product Demo Requests' 
    when Inquiry_Path_Classification = 'Camp Member - Demo HandRaiser' 
    and  all_Demo_status= 'Demo Requested from Product' then 'In-product Demo Requests'
    when Inquiry_Path_Classification='Trials' then 'Trials' 
  end as trials_demo_request_Classification,
    nmc.orig_camp,
    nmc.landing_page,
    nmc.new_mktg_class,
    nmc.lp_cluster,
     company_size_bucket,
    CASE
        WHEN email_type IN ('Business Email Domain', 'Government Email Domain', 'Education Email Domain', 'Personal Email Domain') THEN email_type
        ELSE 'Others'
    END AS email_type,
    CASE
        WHEN country = 'United States' THEN 'US'
        ELSE 'Non-US'
    END AS Country,
    email,
    recent_mql_date ,
    opp_s1_date,
    opportunity_status,
    pipeline_revised,
    acv, -- Adjust the precision and scale for your data
    opp_closedate ,
    opp_iswon,
    first_lead_first_touch_new_mrr ,
    signup_dttm , -- If this field contains both date and time
    first_lead_classification ,
    trial_signups, -- Adjust the data type as needed
    owner_email,
    free_esign_signups, -- Adjust the data type as needed
    lead_create_date,
    lead_inquiry,
    recent_chillipiper_booked_date ,
    recent_drift_booked_date ,
    recent_demo_requested_date 
from dm_main.marketing_channel_ranking_attrib_logic_vw r
left join 
yichi_zhang.new_mktg_classification nmc
on r.first_seen_mode=nmc.first_seen_mode
and r.mktg_chnl=nmc.mktg_chnl
where (recent_mQl_date>='2022-01-01' or 
opp_s1_date >='2022-01-01' or
opp_closedate >='2022-01-01' or 
signup_dttm >='2022-01-01' or 
lead_create_date>='2022-01-01' or 
recent_drift_booked_date>='2022-01-01' or 
recent_chillipiper_booked_date>='2022-01-01' or 
recent_demo_Requested_Date>='2022-01-01'  ) 
and company_size_bucket IN ('1-10', '11-50', '51-200', '201-1000', '1001+')
and email is not null
),
mql as (
SELECT
 language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
    recent_mQl_date AS MQL_Date,
    COUNT(DISTINCT email) AS MQL_Count
FROM New_tb tb
WHERE recent_mql_date >= '2022-01-01'
    AND company_size_bucket IN ('1-10', '11-50', '51-200', '201-1000', '1001+')
GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13
),
--S1
s1 as (
SELECT
 language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
opp_s1_date  as s1_Date,
count(distinct  case when opp_s1_date is not null then email end ) as s1_Count_created,
count(distinct  case when opp_s1_date is not null  and opportunity_status ='Open' then email end ) as s1_Count_open,
sum(distinct  case when opp_s1_date is not null  then pipeline_revised  end ) as s1_Amount_created,
count(distinct  case when opp_s1_date is not null  and opportunity_status ='Open' then pipeline_revised end ) as s1_Amount_open,
sum(case when opp_s1_date is not null then acv end ) as Acv_Amount_created
  from New_tb
 where opp_s1_date >='2022-01-01' 
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
),

--Won
won as (
SELECT
  language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
opp_closedate  as won_Date,
count(distinct  case when opp_closedate is not null and opp_iswon =1
then email end ) as Won_count,
sum( case when opp_closedate is not null and opp_iswon =1 then
pipeline_revised  end) as Won_Pipe_amount,
sum(case when opp_closedate is not null and opp_iswon =1 then
 acv  end ) as Acv_Amount_won,
sum(case when opp_closedate is not null and opp_iswon =1 then
first_lead_first_touch_new_mrr end) as MRR_Amount_won,
sum(case when opp_closedate is not null and opp_iswon =1 then
first_lead_first_touch_new_mrr*12 end) as ARR_Amount_won
  from New_tb
 where opp_closedate >='2022-01-01'  
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
),

--Signup
signup as (
SELECT
 language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
signup_dttm  as signup_Date,
count(distinct  case when first_lead_classification='Free Trial' and  trial_signups=1 and email=owner_email 
then email end ) as core_trial_count,
count(distinct case when free_esign_signups = 1  then email end ) as free_esign_count
 from New_tb 
where signup_dttm >='2022-01-01' 
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
),

--Inquiry
inquiry as (
SELECT
  language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
lead_create_date  as Inquiry_Date,
count(distinct case when lead_inquiry>0 
then email end ) as Inquiry_count
  from New_tb
 where lead_create_date >='2022-01-01' 
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
),
--Demo Booked 
demo_bk as (
SELECT
  language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
case when recent_chillipiper_booked_date is not null  then recent_chillipiper_booked_date
when  recent_drift_booked_date is not null then  recent_drift_booked_date  end as demo_booked_date, 
count(distinct case when recent_chillipiper_booked_date is not null or recent_drift_booked_date is not null then email end ) as demo_booked_count
from New_tb
where (recent_chillipiper_booked_date >='2022-01-01' or recent_drift_booked_date>='2022-01-01') 
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
),
--demo_form
demo_submission as (
SELECT
   language,
  Demo_booked_status_Sales_Ops, 
demo_requested_nonProd,
 demo_request_Prod,
trials_demo_request_Classification,
orig_camp,
   landing_page,
    new_mktg_class,
    LP_Cluster,
    company_size_bucket,
    email_type,
    Country,
recent_demo_Requested_Date as demo_requested_date, 
count(distinct case when recent_demo_Requested_Date is not null then email end ) as demo_requested_count
from New_tb
where recent_demo_Requested_Date >='2022-01-01' 
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
),
 DT AS (
    SELECT DISTINCT
        date_trunc('day',
            COALESCE(
                recent_mql_date,
                opp_s1_date,
                opp_closedate,
                signup_dttm::date,
                lead_create_date,
                recent_drift_booked_date,
                recent_chillipiper_booked_date,
                recent_demo_requested_date
            )
        ) AS date,
        language,
        Demo_booked_status_Sales_Ops,
        demo_requested_nonProd,
        demo_request_Prod,
        trials_demo_request_Classification,
        orig_camp,
        landing_page,
        new_mktg_class,
        LP_Cluster,
        company_size_bucket,
        email_type,
         Country
    FROM New_tb
    WHERE date_trunc('day', COALESCE(
            recent_mql_date,
            opp_s1_date,
            opp_closedate,
            signup_dttm::date,
            lead_create_date,
            recent_drift_booked_date,
            recent_chillipiper_booked_date,
            recent_demo_requested_date
        )) IS NOT NULL
        AND date_trunc('day', COALESCE(
            recent_mql_date,
            opp_s1_date,
            opp_closedate,
            signup_dttm::date,
            lead_create_date,
            recent_drift_booked_date,
            recent_chillipiper_booked_date,
            recent_demo_requested_date
        )) >= '2023-09-01'
         AND date_trunc('day', COALESCE(
            recent_mql_date,
            opp_s1_date,
            opp_closedate,
            signup_dttm::date,
            lead_create_date,
            recent_drift_booked_date,
            recent_chillipiper_booked_date,
            recent_demo_requested_date
        )) <current_date
),
Result AS (
    SELECT
        dt.date,
        dt.language,
        dt.Demo_booked_status_Sales_Ops,
        dt.demo_requested_nonProd,
        dt.demo_request_Prod,
        dt.trials_demo_request_Classification,
        dt.orig_camp,
        dt.landing_page,
        dt.new_mktg_class,
        dt.LP_Cluster,
        dt.company_size_bucket,
        dt.email_type,
        dt.Country,
   max(nvl(core_trial_count,0)) as core_trial_count,
   max(nvl(free_esign_count,0)) as free_esign_count,
   max(nvl(demo_booked_count,0)) as demo_booked_count,
   max(nvl(Inquiry_count,0)) as Inquiry_count,
   max(nvl(MQL_Count,0)) as MQL_Count,
   max(nvl(demo_requested_count,0)) as demo_requested_count,
   max(nvl(s1_Count_created,0)) as s1_Count_created,
   max(nvl(s1_Count_open,0)) as s1_Count_open,
   max(nvl(s1_Amount_created,0)) as s1_Amount_created,
   max(nvl(s1_Amount_open,0)) as s1_Amount_open,
   max(nvl(Acv_Amount_created,0)) as Acv_Amount_created,
   max(nvl(Won_count,0)) as Won_count,
   max(nvl(Won_Pipe_amount,0)) as Won_Pipe_amount,
   max(nvl(Acv_Amount_won,0)) as Acv_Amount_won ,
  max(nvl(MRR_Amount_won,0)) as MRR_Amount_won,
  max(nvl(ARR_Amount_won,0)) as ARR_Amount_won
from dt left join signup 
on date_trunc('day',dt.date)=date_trunc('day',signup.signup_Date)
and nvl(dt.language,'NA')=nvl(signup.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(signup.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(signup.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(signup.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(signup.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(signup.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(signup.landing_page,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(signup.new_mktg_class,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(signup.LP_Cluster,'NA')
and nvl(dt.company_size_bucket,'NA')=nvl(signup.company_size_bucket,'NA')
and nvl(dt.email_type,'NA')=nvl(signup.email_type,'NA')
and nvl(dt.Country,'NA')=nvl(signup.Country,'NA')
left join demo_bk dbk 
on date_trunc('day',dt.date)=date_trunc('day',dbk.demo_booked_date)
and nvl(dt.language,'NA')=nvl(dbk.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(dbk.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(dbk.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(dbk.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(dbk.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(dbk.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(dbk.landing_page,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(dbk.LP_Cluster,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(dbk.new_mktg_class,'NA')
and nvl(dt.company_size_bucket,'NA')=nvl(dbk.company_size_bucket,'NA')
and nvl(dt.email_type,'NA')=nvl(dbk.email_type,'NA')
and nvl(dt.Country,'NA')=nvl(dbk.Country,'NA')
left join inquiry iq 
on date_trunc('day',dt.date)=date_trunc('day',iq.Inquiry_date)
and NVL(dt.language,'NA')=NVL(iq.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(iq.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(iq.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(iq.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(iq.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(iq.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(iq.landing_page,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(iq.LP_Cluster,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(iq.new_mktg_class,'NA')
and NVL(dt.company_size_bucket,'NA')=nvl(iq.company_size_bucket,'NA')
and NVL(dt.email_type,'NA')=nvl(iq.email_type,'NA')
and NVL(dt.Country,'NA')=nvl(iq.Country,'NA')
left join mql
on date_trunc('day',dt.date)=date_trunc('day',mql.mql_date)
and nvl(dt.language,'NA')=nvl(mql.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(mql.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(mql.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(mql.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(mql.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(mql.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(mql.landing_page,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(mql.LP_Cluster,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(mql.new_mktg_class,'NA')
and nvl(dt.company_size_bucket,'NA')=nvl(mql.company_size_bucket,'NA')
and nvl(dt.email_type,'NA')=nvl(mql.email_type,'NA')
and nvl(dt.Country,'NA')=nvl(mql.Country,'NA')
left join demo_submission dsm 
on date_trunc('day',dt.date)=date_trunc('day',dsm.demo_requested_date)
and nvl(dt.language,'NA')=nvl(dsm.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(dsm.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(dsm.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(dsm.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(dsm.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(dsm.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(dsm.landing_page,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(dsm.LP_Cluster,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(dsm.new_mktg_class,'NA')
and nvl(dt.company_size_bucket,'NA')=nvl(dsm.company_size_bucket,'NA')
and nvl(dt.email_type,'NA')=nvl(dsm.email_type,'NA')
and nvl(dt.Country,'NA')=nvl(dsm.Country,'NA')
left join s1 
on date_trunc('day',dt.date)=date_trunc('day',s1.s1_date)
and nvl(dt.language,'NA')=nvl(s1.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(s1.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(s1.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(s1.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(s1.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(s1.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(s1.landing_page,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(s1.LP_Cluster,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(s1.new_mktg_class,'NA')
and NVL(dt.company_size_bucket,'NA')=nvl(s1.company_size_bucket,'NA')
and nvl(dt.email_type,'NA')=nvl(s1.email_type,'NA')
and nvl(dt.Country,'NA')=nvl(s1.Country,'NA')
left join won 
on date_trunc('day',dt.date)=date_trunc('day',won.won_date)
and nvl(dt.language,'NA')=nvl(won.language,'NA') 
and nvl(dt.Demo_booked_status_Sales_Ops,'NA')=nvl(won.Demo_booked_status_Sales_Ops,'NA')
and nvl(dt.demo_requested_nonProd,'NA')=nvl(won.demo_requested_nonProd,'NA')
and NVL(dt.demo_request_Prod,'NA')=nvl(won.demo_request_Prod,'NA')
and NVL(dt.trials_demo_request_Classification,'NA')=nvl(won.trials_demo_request_Classification,'NA')
and NVL(dt.orig_camp,'NA')=nvl(won.orig_camp,'NA')
and NVL(dt.landing_page,'NA')=nvl(won.landing_page,'NA')
and NVL(dt.LP_Cluster,'NA')=nvl(won.LP_Cluster,'NA')
and NVL(dt.new_mktg_class,'NA')=nvl(won.new_mktg_class,'NA')
and NVL(dt.company_size_bucket,'NA')=nvl(won.company_size_bucket,'NA')
and NVL(dt.email_type,'NA')=nvl(won.email_type,'NA')
and NVL(dt.Country,'NA')=nvl(won.Country,'NA')
group by 1 ,2,3,4,5,6,7,8,9,10,11,12,13
order by 14 desc
)

select *, rank() over (partition by  date_trunc('month',date) order by demo_landing_page desc) as demo_landing_page_rk,
dense_rank() over (partition by  date_trunc('month',date) order by mql_landing_page desc) as mql_landing_page_rk,
dense_rank() over (partition by date_trunc('month',date) order by core_trial_landing_page desc) as core_trial_landing_page_rk,
dense_rank() over (partition by  date_trunc('month',date) order by free_esign_landing_page desc) as free_esign_landing_page_rk,
dense_rank() over (partition by  date_trunc('month',date) order by Inquiry_landing_page desc) as Inquiry_landing_page_rk,
dense_rank() over (partition by  date_trunc('month',date) order by s1_created_landing_page desc) as s1_created_landing_page_rk,
dense_rank() over (partition by date_trunc('month',date) order by won_landing_page desc) as won_landing_page_rk
from
(select *, 
sum (demo_booked_count) over (partition by  date_trunc('month',date),landing_page) as demo_landing_page ,
sum (mql_count) over (partition by landing_page, date_trunc('month',date)) as mql_landing_page,
sum (core_trial_count) over (partition by landing_page, date_trunc('month',date)) as core_trial_landing_page,
sum (free_esign_count) over (partition by landing_page, date_trunc('month',date)) as free_esign_landing_page,
sum (Inquiry_count) over (partition by landing_page, date_trunc('month',date)) as Inquiry_landing_page,
sum (s1_Count_created) over (partition by landing_page, date_trunc('month',date)) as s1_created_landing_page,
sum (Won_count) over (partition by landing_page, date_trunc('month',date)) as won_landing_page
from
(SELECT
    *
FROM Result
ORDER BY date DESC))

;
